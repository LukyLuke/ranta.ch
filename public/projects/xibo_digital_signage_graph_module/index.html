<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <title>
    Graph module for Xibo // RANTA - Coding, Hacking, Teaching and more
  </title>

  <link href="http://gmpg.org/xfn/11" rel="profile">
<meta http-equiv="content-type" content="text/html; charset=utf-8">


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<meta name="description" content="A Graph module, based on the famouse RGraph Library, for Xibo Digital Signage">
<meta name="keywords" content="">
<meta name="author" content="">
<meta name="generator" content="Hugo 0.18.1" />

  <meta property="og:title" content="Graph module for Xibo" />
<meta property="og:description" content="A Graph module, based on the famouse RGraph Library, for Xibo Digital Signage" />
<meta property="og:type" content="website" />
<meta property="og:locale" content="en_US" />
<meta property="og:url" content="//ranta.ch/projects/xibo_digital_signage_graph_module/" />


  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/base-min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/pure-min.css">
  
  
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/grids-responsive-min.css">
  
  

  <link rel="stylesheet" href="//ranta.ch//css/redlounge.css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
  <link rel="shortcut icon" type="image/x-icon" href="/img/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="RANTA - Coding, Hacking, Teaching and more" />

    
  <link rel="stylesheet" href="/css/styles/color-brewer.css">
  <script src="/js/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>


  

  
    <link rel="stylesheet" type="text/css" href="/css/ranta-changes.css">
  

  
</head>

<body>
	

	<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
  <div class="header">
    

	
	  <img src="/page/ranta.jpg" class="sidebarphoto">
	

    <h1 class="brand-title">Ranta</h1>
    <h2 class="brand-tagline">Coding, Hacking, Teaching, Robotics, Security and more</h2>

    <nav class="nav">
      <ul class="nav-list">
        <li class="nav-item"><span class="nav-item-separator">//</span><a href="//ranta.ch/">Home</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/posts">Articles</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/projects">Projects</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/tutorials">Tutorials</a></li>
        
      </ul>
    </nav>

    
    <div class="social-buttons">
      
        
        <a href="http://www.github.com/LukyLuke" target="_blank"><i class='fa fa-github'></i></a>
        
      
        
        <a href="http://www.twitter.com/ranta_plan" target="_blank"><i class='fa fa-twitter'></i></a>
        
      
      
    </div>
    

  </div>
</div>

	
	

    <div class="content pure-u-1 pure-u-md-3-4">
		<a name="top"></a>
		

		
			
		    <div id="toc" class="pure-u-1 pure-u-md-1-4">
				<small class="toc-label">Contents</small>
		   	 	<nav id="TableOfContents">
<ul>
<li><a href="#installation">Installation</a></li>
<li><a href="#settings">Settings</a></li>
<li><a href="#developing">Developing</a>
<ul>
<li><a href="#files">Files</a></li>
</ul></li>
</ul>
</nav>
		    </div>
		    
	    
  		<section class="post">
            <h1 class="post-title">
              <a href="/projects/xibo_digital_signage_graph_module/">Graph module for Xibo</a>
            </h1>
            <h3 class="post-subtitle">
            	
            </h3>
            
            	<span class="post-date">
                	<span class="post-date-day"><sup>2</sup></span><span class="post-date-separator">/</span><span class="post-date-month">May</span> <span class="post-date-year">2017</span>
            	</span>
            	
            
            	
            

			
			
				<div class="post-categories">
				
					<a class="post-category post-category-development" href="//ranta.ch//categories/development">Development</a>
				
					<a class="post-category post-category-php" href="//ranta.ch//categories/php">PHP</a>
				
				</div>
			

			

			

            

<p><a href="http://xibo.org.uk/">Xibo</a> is a powerfull Open Source Digital Signange CMS to bring Content to public Displays. In our Company in my Team we wanted to display the amount of bugs versus the amunt of UnitTests, Codecoverage and others. Therefore out central IT department gave us Access to our Xibo installation where we where able to show pages from Jira, SonarCube and others. With that I was not really happy and started to create a custom module for Xibo to draw graphs with data from one but also multiple systems over time. See <a href="https://github.com/LukyLuke/xibo_rgraph">Github LukyLuke/xibo_rgraph</a>.</p>

<p>To show graphs on a Website I found <a href="https://www.rgraph.net/">RGraph</a> some time ago. This was for now the ideal JavaScript-Library to use with Xibo, becasue it has Canvas- and SVG Support which is supported by the used Internet-Explorere component in the Xibo-Client.</p>

<h1 id="installation">Installation</h1>

<p>What you need is a running Xibo-1.8 installation.
Download or clone <a href="https://github.com/LukyLuke/xibo_rgraph">Github LukyLuke/xibo_rgraph</a> directly into the xibo installation (or copy everything). The folder structure should match and there is no need for more setup or any other downloads.</p>

<p>After this, go to the module settings page and enable the <code>RGraph</code> Module.</p>

<h1 id="settings">Settings</h1>

<p>Currently the module is working as expected and is able to display one DataSet from the internally managed DataStore, or it can request up to two JSON-RPC for fetching data from remote hosts.</p>

<p>In the main settings dialog you can define the default colors used for printing the Graphs. Not forget to enable the Module here.</p>

<p><img src="/images/xibo_rgraph/rgraph_module_settings.png" alt="Main Module settings" /></p>

<p>On the page settings there are a lot of settings to make. On the main page you have to choose the type of graph to show:</p>

<p><img src="/images/xibo_rgraph/rgraph_module_page_1.png" alt="General Page settings" /></p>

<p>On the Data-Pane you can choose the type of Data to show. Depending on the selection even &ldquo;JSON&rdquo; or &ldquo;Dataset&rdquo; is shown on the panes area.</p>

<p><img src="/images/xibo_rgraph/rgraph_module_page_2.png" alt="Data settings" /></p>

<p>The optional Javascript is for creating the right data-structure for RGraph. If you&rsquo;re using a DataSet, just <code>return json</code>.
For Example there could be something like this when you request Data from SonarCube:</p>

<pre><code class="language-javascript">function prepareJsonData(json, json2) {
    // This function will be called just after the JSON/Datastream data is received.
    // In here you have to prepare the data to be in teh right format for the RGraph-Library:
    //    data = { data: [val, val, val, ...],
    //             labels: [lbl, lbl, lbl, ...],
    //             legend: [lbl, lbl, lbl, ...] }
    // or if you have more than one Data-Stream to visualize (bar, line, radar, waterfall, scatter):
    //    data = { data: [[val, val, val, ...], [val, val, val, ...]],
    //             labels: [lbl, lbl, lbl, ...],
    //             legend: [lbl, lbl, lbl, ...] }
    //
    // The 'data' contains all Data values as nummeric (float/integer)
    // The 'labels' contains all X-Axis labels. For better readibility just show every 10th label only
    // The 'legend' contains all keys to show the legend. The real values are evaluated with the 'geLabel(key)' function above
    var data = {data:[], labels:[], legend: []};
    for (x in json2[0].cols) {
        data.data.push([]);
        data.legend.push(json2[0].cols[x].metric);
    }
    for (x in json2[0].cells) {
        var time = json2[0].cells[x].d;
        var values = json2[0].cells[x].v;
        if (x%10 == 0) data.labels.push(time);
        for (y in values) {
            data.data[y].push(values[y]);
        }
    }
    return data;
}
</code></pre>

<p>Here for example a JSON-Request Settings-Page:</p>

<p><img src="/images/xibo_rgraph/rgraph_module_page_3.png" alt="JSON settings" /></p>

<p>On the second JSON-RPC Uri (and also post-data area) you can use all values from the first JSON-Response.
If for example the first Call results in a Data-Structure like this: <code>Object { first: [val1, val2], second: { first: Hello, second: World } }</code> and so on, you can use <code>${first[0]}</code> for <em>val1</em> or <code>${second.first} ${second.second}</code> for a <em>Hello World</em> in the URI and Post-Data.</p>

<p>On the last page, the Advaced panel, you can define to show a legend and position it. Depending on what you select the field disapear magically :)</p>

<p><img src="/images/xibo_rgraph/rgraph_module_page_4.png" alt="Advanced settings" /></p>

<p>The optional Javascript is for a mapping from Label-Keys to a human readable String. For Example there could be something like this when you request Data from SonarCube:</p>

<pre><code class="language-javascript">function getLabel(key) {
    // This function is called for each Data-Stream you are going to visualize.
    // Just make a simple &quot;swicth-case&quot; construct in here and return a human readable label for each data-stream key
    switch (key) {
        case &quot;line_coverage&quot;: return &quot;Lines covered by UnitTests&quot;;
        case &quot;branch_coverage&quot;: return &quot;Conditions covered by UnitTests&quot;;
        default: return key;
    }
}
</code></pre>

<p>Finally you will see something like this in on the Layout-Page:</p>

<p><img src="/images/xibo_rgraph/rgraph_module_preview.png" alt="Layout Preview" /></p>

<h1 id="developing">Developing</h1>

<p>Developing a new custom module for Xibo id quite easy. There is a good documentation but more helpful for me where the eisting modules.</p>

<p>All in All this are the main steps:
* Create a folder named like your module in the <code>custom</code> Folder
* Create a File in the <code>custom</code> Folder named like <code>MODULE.json</code> with Content like this:</p>

<pre><code class="language-json">{
  &quot;title&quot;: &quot;RGraph Data-Visualization&quot;,
  &quot;author&quot;: &quot;Lukas Zurschmiede&quot;,
  &quot;description&quot;: &quot;A module to visualize data from JSON or a local Datastore with a Graph.&quot;,
  &quot;name&quot;: &quot;rgraph&quot;,
  &quot;class&quot;: &quot;Xibo\\Custom\\MODULE\\MODULE&quot;
}
</code></pre>

<ul>
<li>If you need 3rd-Party Libraries, create a Folder <code>web/vendor/MODULE</code> and place all Files in there.</li>
<li>If you need images or other resources, place them in <code>web/modules/MODULE</code>.</li>
<li>In your <code>custom/MODULE</code> Folder create the Class-File and the Template-Files:
** Case sensitive: MODULE.php
** Lower-Case: MODULE-form-add.twig
** Lower-Case: MODULE-form-edit.twig
** Optionally I think, Lower-Case: MODULE-form-settings.twig</li>
</ul>

<h2 id="files">Files</h2>

<p>For example twig files check out the existing templates in the <code>modules</code> Folder.</p>

<p>The built-in modules you find in the `` Folder.
Basically a module has the following structure:</p>

<pre><code class="language-php">namespace Xibo\Custom\MODULE;

use InvalidArgumentException;
use Respect\Validation\Validator as v;

class MODULE extends \Xibo\Widget\ModuleWidget {
	public $codeSchemaVersion = 1;
	private $resourceFolder;
	
	/**
	 * MODULE constructor.
	 * @Override
	 */
	public function init() {
		$this-&gt;resourceFolder = PROJECT_ROOT . '/web/modules/MODULE';
		v::with('Xibo\\Validation\\Rules\\');
	}
	
	/**
	 * Install or Update this module
	 * @param ModuleFactory $moduleFactory
	 * @Override
	 */
	public function installOrUpdate($moduleFactory) {
		// Install
		if ($this-&gt;module == null) {
			$module = $moduleFactory-&gt;createEmpty();
			$module-&gt;name = 'MODULE';
			$module-&gt;type = 'MODULE'; // lower-case
			$module-&gt;viewPath = '../custom/MODULE';
			$module-&gt;class = 'Xibo\Custom\MODULE\MODULE';
			$module-&gt;description = 'Graphical data visualization';
			$module-&gt;imageUri = 'forms/library.gif';
			$module-&gt;enabled = 1;
			$module-&gt;previewEnabled = 1;
			$module-&gt;assignable = 1;
			$module-&gt;regionSpecific = 1;
			$module-&gt;renderAs = 'html';
			$module-&gt;schemaVersion = $this-&gt;codeSchemaVersion;
			$module-&gt;defaultDuration = 240;
			$module-&gt;settings = [];
			$this-&gt;setModule($module);
			$this-&gt;installModule();
		}
		// Check we are all installed
		$this-&gt;installFiles();
	}
	
	/**
	 * Install all 3rd-Party Files
	 */
	public function installFiles() {
		$this-&gt;mediaFactory-&gt;createModuleSystemFile(PROJECT_ROOT . '/web/modules/vendor/MODULE/....js')-&gt;save();
		$this-&gt;mediaFactory-&gt;createModuleSystemFile(PROJECT_ROOT . '/web/modules/vendor/MODULE/....js')-&gt;save();
	}
	
	/**
	 * Optional: Remove this method if there is no special settings form
	 *
	 * Form for updating the module settings
	 * @return Name of the Settings-Form
	 * @Override
	 */
	public function settingsForm() {
		return 'module-form-settings';
	}
	
	/**
	 * Process any module settings
	 * @return An array of the processed settings.
	 * @Override
	 */
	public function settings() {
		$this-&gt;module-&gt;settings['SETTING_NAME'] = $this-&gt;getSanitizer()-&gt;getString('SETTING_NAME', ...);
		$this-&gt;module-&gt;settings['SETTING_NAME'] = $this-&gt;getSanitizer()-&gt;getString('SETTING_NAME', ...);
		return $this-&gt;module-&gt;settings;
	}
	
	/**
	 * Validates the settings when saving a layout
	 * @Override
	 */
	public function validate() {
		if ($this-&gt;getUseDuration() == 1 &amp;&amp; $this-&gt;getDuration() == 0)
			throw new InvalidArgumentException(__('You must enter a duration.'));
	}
	/**
	 * Adds a Widget
	 * @Override
	 */
	public function add() {
		$this-&gt;setOption('name', $this-&gt;getSanitizer()-&gt;getString('name'));
		$this-&gt;setUseDuration($this-&gt;getSanitizer()-&gt;getCheckbox('useDuration'));
		$this-&gt;setDuration($this-&gt;getSanitizer()-&gt;getInt('duration', $this-&gt;getDuration()));
		
		$this-&gt;setOption('SETTING_NAME', $this-&gt;getSanitizer()-&gt;getString('SETTING_NAME'));
		$this-&gt;setOption('SETTING_NAME', $this-&gt;getSanitizer()-&gt;getString('SETTING_NAME'));
		
		$this-&gt;validate();
		$this-&gt;saveWidget();
	}
	/**
	 * Edit the Widget
	 * @Override
	 */
	public function edit() {
		$this-&gt;setOption('name', $this-&gt;getSanitizer()-&gt;getString('name'));
		$this-&gt;setUseDuration($this-&gt;getSanitizer()-&gt;getCheckbox('useDuration'));
		$this-&gt;setDuration($this-&gt;getSanitizer()-&gt;getInt('duration', $this-&gt;getDuration()));
		
		$this-&gt;setOption('SETTING_NAME', $this-&gt;getSanitizer()-&gt;getString('SETTING_NAME'));
		$this-&gt;setOption('SETTING_NAME', $this-&gt;getSanitizer()-&gt;getString('SETTING_NAME'));
		
		$this-&gt;validate();
		$this-&gt;saveWidget();
	}
	
	/**
	 * Preview code for a module
	 * 
	 * @param int $width
	 * @param int $height
	 * @param int $scaleOverride The Scale Override
	 * @return string The Rendered Content
	 * @Override
	 */
	public function preview($width, $height, $scaleOverride = 0) {
		return $this-&gt;previewAsClient($width, $height, $scaleOverride);
	}
	
	/**
	 * GetResource for the Graph page
	 * 
	 * @param int $displayId
	 * @return mixed|string
	 * @Override
	 */
	public function getResource($displayId = 0) {
		// Load in the template
		$data = [];
		
		// Replace the View Port Width?
		$isPreview = ($this-&gt;getSanitizer()-&gt;getCheckbox('preview') == 1);
		
		// Replace the View Port Width?
		$data['viewPortWidth'] = ($isPreview) ? $this-&gt;region-&gt;width : '[[ViewPortWidth]]';
		
		// Head Content contains all needed scrips from XY
		$headContent  = '&lt;script type=&quot;text/javascript&quot; src=&quot;' . $this-&gt;getResourceUrl('vendor/MODULE/....js') . '&quot;&gt;&lt;/script&gt;'.&quot;\n&quot;;
		$data['head'] = $headContent;
		
		// Body content
		$data['body'] = '&lt;div id=&quot;MODULE_Content_Whatever_' . $displayId . '&quot;&gt;
			Put and create here your HTML
		&lt;/div&gt;';
		
		// After body content - mostly XIBO-Stuff for scaling and so on
		$javaScriptContent  = '&lt;script type=&quot;text/javascript&quot; src=&quot;' . $this-&gt;getResourceUrl('vendor/jquery-1.11.1.min.js') . '&quot;&gt;&lt;/script&gt;';
		$javaScriptContent .= '&lt;script type=&quot;text/javascript&quot; src=&quot;' . $this-&gt;getResourceUrl('xibo-layout-scaler.js') . '&quot;&gt;&lt;/script&gt;';
		$javaScriptContent .= '&lt;script&gt;
			$(document).ready(function() {
				var options = ' . json_encode($options) . '
				$(&quot;#' . $containerId . '&quot;).xiboLayoutScaler(options);
		});
		
		// Replace the After body Content
		$data['javaScript'] = $javaScriptContent;
		return $this-&gt;renderTemplate($data);
	}
	
	/**
	 * Returns if this module is valid or not.
	 *   0 =&gt; Invalid
	 *   1 =&gt; Valid
	 *   2 =&gt; Unknown
	 * @return Validation-Level
	 * @Override
	 */
	public function IsValid() {
		// Can't be sure because the client does the rendering
		return 2;
	}
}
</code></pre>

	
			

			
				<div class="tags-list">
					<span class="dark-red">Tags</span><span class="decorative-marker">//</span>
					
	                <a class="post-tag post-tag-development" href="//ranta.ch//tags/development">Development</a>,
	                
	                <a class="post-tag post-tag-php" href="//ranta.ch//tags/php">php</a>,
	                
	                <a class="post-tag post-tag-opensource" href="//ranta.ch//tags/opensource">Opensource</a>,
	                
	                <a class="post-tag post-tag-mit" href="//ranta.ch//tags/mit">MIT</a>,
	                
	                <a class="post-tag post-tag-xibo" href="//ranta.ch//tags/xibo">xibo</a>,
	                
	                <a class="post-tag post-tag-graph" href="//ranta.ch//tags/graph">graph</a>,
	                
	                <a class="post-tag post-tag-rgraph" href="//ranta.ch//tags/rgraph">rgraph</a>,
	                
	                <a class="post-tag post-tag-digitale" href="//ranta.ch//tags/digitale">digitale</a>,
	                
	                <a class="post-tag post-tag-signage" href="//ranta.ch//tags/signage">signage</a>,
	                
	                <a class="post-tag post-tag-module" href="//ranta.ch//tags/module">module</a>,
	                
	                <a class="post-tag post-tag-php" href="//ranta.ch//tags/php">php</a>,
	                
	                <a class="post-tag post-tag-javascript" href="//ranta.ch//tags/javascript">javascript</a>,
	                
				</div>
			

			
				<div class="paging">
					<span class="paging-label">More Reading</span>
					
					<div class="paging-newer">
						<span class="dark-red">Newer</span><span class="decorative-marker">//</span>
						<a class="paging-link" href="/tutorials/ESP-32-Initial/">ESP-32/ESP-WROOM-32 verkabeln und programmieren</a>
		            </div>
		            

					
					<div class="paging-older">
						<span class="dark-red">Older</span><span class="decorative-marker">//</span>
			            <a class="paging-link" href="/tutorials/Programming_Arduino_With_Kdevelop/">Adruino programmieren mit KDevelope</a>
		            </div>
		            
	            </div>
            
          </section>
          
          	
          
        
      <div class="footer">
	<hr class="thin" />
	<div class="pure-menu pure-menu-horizontal pure-menu-open">
		<ul class="footer-menu">
		
		</ul>
	</div>

	<p>&copy; 2017. All rights reserved.</p>
</div>
    </div>
  </div>
	

	

  
</body>
</html>
